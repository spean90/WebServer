<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webserver.dao.UserCouponDao">

	<select id="getUserCouponListByParams" resultType="UserCoupon">
		select t.id,t.user_id userId,t.coupon_id couponId,t.coupon_package_id couponPackageId,t.status status,
		t.create_time createTime,a.dead_time deadTime,a.coupon_name couponName,a.type type,a.is_deliver isDeliver,
		a.sum sum,a.coupon_desc couponDesc,a.product_ids productIds,
		b.user_name userName
		from user_coupon t
		left join coupon a on t.coupon_id=a.coupon_id
		left join user_info b on t.user_id = b.user_id
		<where>
		<if test="userCoupon.couponId != null and userCoupon.couponId != ''">
			and t.coupon_id  = #{userCoupon.couponId} 
		</if>
		<if test="userCoupon.userId != null and userCoupon.userId != ''">
			and t.user_id  = #{userCoupon.userId} 
		</if>
		<if test="userCoupon.deadTime != null and userCoupon.deadTime != ''">
			and a.dead_time >= #{userCoupon.deadTime}
		</if>
		<if test="userCoupon.type != null and userCoupon.type != ''">
			and a.type = #{userCoupon.type}
		</if>
		<if test="userCoupon.status != null and userCoupon.status != ''">
			and t.status = #{userCoupon.status}
		</if>
		<if test="userCoupon.userName != null and userCoupon.userName != ''">
			and b.user_name like concat('%',#{userCoupon.userName },'%')
		</if>
		</where>
		order by t.id desc
		<if test="pageBean!= null">
			limit #{pageBean.start}, #{pageBean.rows}
		</if>
	</select>
	
	<select id="getUserCouponById" resultType="UserCoupon">
		select t.id,t.user_id userId,t.coupon_id couponId,t.coupon_package_id couponPackageId,t.status status,
		t.create_time createTime,a.dead_time deadTime,a.coupon_name couponName,a.type type,a.is_deliver isDeliver,
		a.sum sum,a.coupon_desc couponDesc,a.product_ids productIds
		from user_coupon t
		left join coupon a on t.coupon_id=a.coupon_id
		where t.id = #{userCouponId} and t.user_id = #{userId} and t.status = 1
	</select>
	
	
	<insert id="addUserCoupon" parameterType="UserCoupon" >
		insert into user_coupon (user_id, coupon_id,coupon_package_id, create_time,status) 
		VALUES (#{userCoupon.userId}, #{userCoupon.couponId},  #{userCoupon.couponPackageId},#{userCoupon.createTime},#{userCoupon.status})
	</insert>
	
	 
	 <update id="updateUserCoupon" parameterType="UserCoupon">
		update user_coupon 
		<set>
	 		<if test="userCoupon.status != null and userCoupon.status != ''">
				status = #{userCoupon.status}
			</if>
	 	</set>
	 	where id = #{userCoupon.id}
	</update>
	
</mapper>
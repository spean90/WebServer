<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webserver.dao.GasOrderDao">

	<select id="getGasOrderListByParams" resultType="GasOrder">
		select t.oid oId,t.user_id userId,t.sub_product_id subProductId, t.product_id productId, t.order_id orderId, t.sum sum, t.create_time createTime,t.gas_id gasId,t.amount,t.order_desc orderDesc,t.user_coupon_id userCouponId,
		t.pay_order_id payOrderId ,t.coupon_id couponId,t.pay_sum paySum,t.pay_type payType,t.pay_account payAccount,receiver,t.status status ,t.pay_time payTime,t.buy_gas_account buyGasAccount,t.buy_gas_company buyGasCompany,t.buy_gas_phone buyGasPhone
		,t.refund_man refundMan,t.refund_sign refundSign,t.refund_time refundTime,t.refund_sum refundSum
		,a.user_name userName
		,b.gas_account gasAccount ,b.company company 
		,c.product_name productName,c.product_desc productDesc
		,d.coupon_name couponName,d.sum couponSum
		from gas_order t
		left join user_info a on t.user_id=a.user_id
		left join gas_card b on b.gas_id = t.gas_id
		left join product c on t.product_id = c.product_id
		left join coupon d on t.coupon_id = d.coupon_id
		<where>
		<if test="gasOrder.userId != null and gasOrder.userId != ''">
			and t.user_id = #{gasOrder.userId}
		</if>
		<if test="gasOrder.productId != null and gasOrder.productId != ''">
			and t.product_id = #{gasOrder.productId}
		</if>
		<if test="gasOrder.orderId != null and gasOrder.orderId != ''">
			and t.order_id = #{gasOrder.orderId}
		</if>
		<if test="gasOrder.payOrderId != null and gasOrder.payOrderId != ''">
			and t.pay_order_id = #{gasOrder.payOrderId}
		</if>
		 <choose>
		    <when test="gasOrder.status!=null and gasOrder.status =='3'">
		      AND t.status = 3 or t.status = 5<!-- 3:申请退款；5-退款中（锁单） -->
		    </when>
		    <when test="gasOrder.status != null">
		      and t.status = #{gasOrder.status}
		    </when>
		 </choose>
		<if test="gasOrder.beginTime != null and gasOrder.beginTime != ''">
			and t.create_time >= #{gasOrder.beginTime}
		</if>
		<if test="gasOrder.endTime != null and gasOrder.endTime != ''">
			<![CDATA[
				and t.create_time <= #{gasOrder.endTime}
			]]>
		</if>
		<if test="gasOrder.userName != null and gasOrder.userName != ''">
			and a.user_name like concat('%',#{gasOrder.userName},'%')
		</if>
		<if test="gasOrder.userCouponId != null and gasOrder.userCouponId != ''">
			and t.user_coupon_id like concat('%',#{gasOrder.userCouponId},'%')
		</if>
			and t.del_status != 1
		</where>
		order by oid desc 
		<if test="pageBean!= null">
			limit #{pageBean.start}, #{pageBean.rows}
		</if>
	</select>
	
	<select id="countProductByParams" resultType="java.util.Map">
		select t.product_id productId,sum(amount) amount,sum(t.sum) sum, sum(t.pay_sum) paySum,a.product_name productName
		from gas_order t
		left join product a on t.product_id = a.product_id
		<where>
		<if test="gasOrder.beginTime != null and gasOrder.beginTime != ''">
			and t.create_time >= #{gasOrder.beginTime}
		</if>
		<if test="gasOrder.endTime != null and gasOrder.endTime != ''">
			<![CDATA[
				and t.create_time <= #{gasOrder.endTime}
			]]>
		</if>
		and t.del_status != 1 and t.status = 2
		</where>
		group by productId
		<if test="pageBean!= null">
			limit #{pageBean.start}, #{pageBean.rows}
		</if>
	</select>
	<select id="countSumByUser" resultType="java.util.Map">
		select sum(amount) amount,sum(t.sum) sum, sum(t.pay_sum) paySum,t.user_id userId
		,a.user_name userName
		from gas_order t
		left join user_info a on t.user_id=a.user_id
		<where>
		<if test="gasOrder.userName != null and gasOrder.userName != ''">
			and a.user_name like concat('%',#{gasOrder.userName},'%')
		</if>
		<if test="gasOrder.recommendId != null and gasOrder.recommendId != '' and gasOrder.recommendId !='admin'">
			and a.recommend_id = #{gasOrder.recommendId}
		</if>
		<if test="gasOrder.beginTime != null and gasOrder.beginTime != ''">
			and t.create_time >= #{gasOrder.beginTime}
		</if>
		<if test="gasOrder.endTime != null and gasOrder.endTime != ''">
			<![CDATA[
				and t.create_time <= #{gasOrder.endTime}
			]]>
		</if>
		and t.del_status != 1 and status = 2
		</where>
		group by userId
		order by paySum desc
		<if test="pageBean!= null">
			limit #{pageBean.start}, #{pageBean.rows}
		</if>
	</select>
	
	<select id="countProductDetail" resultType="java.util.Map">
		select  SUM(sum) productSum , t.product_id productId ,DATE_FORMAT(t.create_time,#{gasOrder.createTime}) createTime
		,a.product_name productName
		from gas_order t
		left join product a on t.product_id = a.product_id
		<where>
		<if test="gasOrder.productId != null and gasOrder.productId != ''">
			and t.product_id =#{gasOrder.productId}
		</if>
		<if test="gasOrder.beginTime != null and gasOrder.beginTime != ''">
			and t.create_time >= #{gasOrder.beginTime}
		</if>
		<if test="gasOrder.endTime != null and gasOrder.endTime != ''">
			<![CDATA[
				and t.create_time <= #{gasOrder.endTime}
			]]>
		</if>
		and t.del_status != 1 and t.status = 2
		</where>
		group by createTime
		<if test="gasOrder.productId != null and gasOrder.productId != ''">
			,t.product_id
		</if>

		order by createTime 
	</select>
	
	<insert id="addGasOrder" parameterType="GasOrder" useGeneratedKeys="true" keyProperty="gasOrder.oId">
		insert into gas_order (user_id, sub_product_id, product_id, order_id, sum, create_time,gas_id,amount,order_desc,pay_order_id,user_coupon_id,coupon_id,pay_sum,pay_account,pay_type,status,buy_gas_account,buy_gas_company,buy_gas_phone) 
		VALUES (#{gasOrder.userId}, #{gasOrder.subProductId}, #{gasOrder.productId}, #{gasOrder.orderId}, #{gasOrder.sum}, #{gasOrder.createTime}, #{gasOrder.gasId}, #{gasOrder.amount}, #{gasOrder.orderDesc}, #{gasOrder.payOrderId}, #{gasOrder.userCouponId},#{gasOrder.couponId}, #{gasOrder.paySum}, #{gasOrder.payAccount}, #{gasOrder.payType}, #{gasOrder.status}, #{gasOrder.buyGasAccount}, #{gasOrder.buyGasCompany}, #{gasOrder.buyGasPhone})
	</insert>
	
	
	<update id="updateGasOrder" parameterType="GasOrder">
		update gas_order 
		<set>
	 		<if test="gasOrder.paySum!=null and gasOrder.paySum!='' ">
	 			pay_sum = #{gasOrder.paySum},
		 	</if>
		 	<if test="gasOrder.orderDesc!=null and gasOrder.orderDesc!='' ">
	 			order_desc = #{gasOrder.orderDesc},
		 	</if>
		 	<if test="gasOrder.status!=null and gasOrder.status!='' ">
	 			status = #{gasOrder.status},
		 	</if>
		 	<if test="gasOrder.receiver!=null and gasOrder.receiver!='' ">
	 			receiver = #{gasOrder.receiver},
		 	</if>
		 	<if test="gasOrder.delStatus!=null and gasOrder.delStatus!='' ">
	 			del_status = #{gasOrder.delStatus},
		 	</if>
		 	<if test="gasOrder.payTime!=null and gasOrder.payTime!='' ">
	 			pay_time = #{gasOrder.payTime},
		 	</if>
		 	<if test="gasOrder.payAccount!=null and gasOrder.payAccount!='' ">
	 			pay_account = #{gasOrder.payAccount},
		 	</if>
		 	<if test="gasOrder.payOrderId!=null and gasOrder.payOrderId!='' ">
	 			pay_order_id = #{gasOrder.payOrderId},
		 	</if>
		 	<if test="gasOrder.refundMan!=null and gasOrder.refundMan!='' ">
	 			refund_man = #{gasOrder.refundMan},
		 	</if>
		 	<if test="gasOrder.refundSign!=null and gasOrder.refundSign!='' ">
	 			refund_sign = #{gasOrder.refundSign},
		 	</if>
		 	<if test="gasOrder.refundTime!=null and gasOrder.refundTime!='' ">
	 			refund_time = #{gasOrder.refundTime},
		 	</if>
		 	<if test="gasOrder.refundSum!=null and gasOrder.refundSum!='' ">
	 			refund_sum = #{gasOrder.refundSum},
		 	</if>
	 	</set>
	 	where oid = #{gasOrder.oId}
	</update>
	
	<update id="updateGasOrderForDeleteGasCard" parameterType="GasOrder">
		update gas_order 
		set del_status = 1
	 	where user_id = #{userId} and status = 1 and del_status!=1
	</update>
	
	<update id="clearUnPayOrder">
		update gas_order
		set del_status = 1
		<![CDATA[
			where create_time <= #{clearTime} and status = 1 and del_status!=1
			]]>
	</update>
	
	<select id="getGasOrderById" resultType="GasOrder">
		select t.oid oId,t.user_id userId,t.sub_product_id subProductId, t.product_id productId, t.order_id orderId, t.sum sum, t.create_time createTime,t.gas_id gasId,t.amount,t.order_desc orderDesc,t.user_coupon_id userCouponId,
		t.pay_order_id payOrderId ,t.coupon_id couponId,t.pay_sum paySum,t.pay_type payType,t.pay_account payAccount,receiver,t.status,t.buy_gas_account buyGasAccount,t.buy_gas_company buyGasCompany,t.buy_gas_phone buyGasPhone
		from gas_order t
		<where>
		<if test="gasOrder.userId != null and gasOrder.userId != ''">
			and t.user_id = #{gasOrder.userId}
		</if>
		<if test="gasOrder.oId != null and gasOrder.oId != ''">
			and t.oid = #{gasOrder.oId}
		</if>
		<if test="gasOrder.orderId != null and gasOrder.orderId != ''">
			and t.order_id = #{gasOrder.orderId}
		</if>
		<if test="gasOrder.status!=null and gasOrder.status!='' ">
	 		and	t.status = #{gasOrder.status}
		</if>
		<if test="gasOrder.couponId!=null and gasOrder.couponId!='' ">
	 		and	t.coupon_id = #{gasOrder.couponId}
		 </if>
		 <if test="gasOrder.gasId!=null and gasOrder.gasId!='' ">
	 		and	t.gas_id = #{gasOrder.gasId}
		 </if>
		  <if test="gasOrder.buyGasAccount!=null and gasOrder.buyGasAccount!='' ">
	 		and	t.buy_gas_account = #{gasOrder.buyGasAccount}
		 </if>
			and t.del_status != 1
		</where>
	</select>
	
</mapper>
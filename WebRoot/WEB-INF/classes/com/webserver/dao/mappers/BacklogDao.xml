<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.webserver.dao.BacklogDao">

	<select id="getBacklogListByParams" resultType="Backlog">
		select t.backlog_id backlogId,t.user_id userId, t.recharge_time rechargeTime, t.create_time createTime, t.gas_id gasId, t.sum sum, t.type type,
		t.status status,t.manager_account managerAccount,t.oid oId,t.update_time updateTime,t.result result,
		a.company company,a.owner owner ,a.gas_account account,a.status gasCardStatus
		,b.order_id orderId
		from backlog t 
		left join gas_card a on a.gas_id = t.gas_id
		left join gas_order b on t.oid = b.oid
		<where>
		<if test="backlog.userId != null">
			and t.user_id = #{backlog.userId}
		</if>
		<if test="backlog.backlogId != null">
			and t.backlog_id = #{backlog.backlogId}
		</if>
		<if test="backlog.type != null">
			and t.type = #{backlog.type}
		</if>
		<if test="backlog.oId != null and backlog.oId != ''">
			and t.oid = #{backlog.oId}
		</if>
		<if test="backlog.owner != null and backlog.owner != ''">
			and a.owner like concat('%',#{backlog.owner},'%') 
		</if>
		<if test="backlog.account != null and backlog.account != ''">
			and a.gas_account like concat('%',#{backlog.account},'%') 
		</if>
		<if test="backlog.status != null and backlog.status != ''">
			and t.status = #{backlog.status}
		</if>
		<if test="backlog.managerAccount != null">
			and t.manager_account = #{backlog.managerAccount}
		</if>
		</where>
		order by backlog_id  desc
		<if test="pageBean!= null">
			limit #{pageBean.start}, #{pageBean.rows}
		</if>
	</select>
	
	
	<insert id="addBacklog" parameterType="Backlog" useGeneratedKeys="true" keyProperty="backlog.backlogId">
		insert into backlog (user_id, recharge_time,  create_time,sum,type,gas_id,status,manager_account ,oid) 
		VALUES (#{backlog.userId}, #{backlog.rechargeTime},  #{backlog.createTime},#{backlog.sum},#{backlog.type},#{backlog.gasId}, #{backlog.status}, #{backlog.managerAccount}, #{backlog.oId})
	</insert>
	
	<update id="updateBacklog"  parameterType="Backlog">
		update backlog
		<set>
	 		<if test="backlog.status!=null and backlog.status!=''">
	 			status = #{backlog.status},
		 	</if>
		 	<if test="backlog.managerAccount!=null and backlog.managerAccount!=''">
	 			manager_account = #{backlog.managerAccount},
		 	</if>
		 	<if test="backlog.updateTime!=null and backlog.updateTime!=''">
	 			update_time = #{backlog.updateTime},
		 	</if>
		 	<if test="backlog.result!=null and backlog.result!=''">
	 			result = #{backlog.result},
		 	</if>
	 	</set>
	 	where backlog_id = #{backlog.backlogId}
	</update>
	<update id="cancelBacklog"  parameterType="Backlog">
		update backlog set status = 5
	 	where oid = #{backlog.oId} and status = 1
	</update>
	
	
	<select id="getBacklogById" resultType="Backlog">
		select t.backlog_id backlogId,t.user_id userId, t.recharge_time rechargeTime, t.create_time createTime, t.gas_id gasId, t.sum sum, t.type type,
		t.status status,t.manager_account managerAccount,t.oid oId,t.update_time updateTime,t.result result,
		a.company company,a.owner owner ,a.gas_account account
		from backlog t
		left join gas_card a on a.gas_id = t.gas_id
		where backlog_id = #{backlogId}
	</select>
	
	<select id="getBackLogListIds" resultType="Backlog">
		select t.backlog_id backlogId,t.user_id userId, t.recharge_time rechargeTime, t.create_time createTime, t.gas_id gasId, t.sum sum, t.type type,
		t.status status,t.manager_account managerAccount,t.oid oId,t.update_time updateTime,t.result result,
		a.company company,a.owner owner ,a.gas_account account
		from backlog t
		left join gas_card a on a.gas_id = t.gas_id
		<if test="backlogIds!=null and backlogIds!=''">
			where backlog_id in
			<foreach item="item" index="index" collection="backlogIds" open="(" separator="," close=")">
				#{item}
			</foreach>
		</if>
		order by backlog_id DESC
	</select>
	<!-- 激活代办事件 -->
	<update id="activateBacklog">
		update backlog
		set status = 1
	 	where status = 0 and 
	 	<![CDATA[
	 		recharge_time <= #{currentTime}
	 	]]>
	</update>
	
	
</mapper>